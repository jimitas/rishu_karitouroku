<script>
    // メインアプリケーション管理
    const App = {
        // グローバル状態管理
        state: {
            studentData: {},
            subjectData: [],
            registeredSubjects: [],
            isLoading: {
                student: false,
                subjects: false,
                registrations: false
            },
            currentTab: 'available'
        },

        // アプリケーション初期化
        init: function () {
            console.log('🚀 履修登録システム開始...');
            console.log('📋 現在の読み込み状態:', document.readyState);

            // DOM読み込み完了後の処理
            document.addEventListener('DOMContentLoaded', () => {
                console.log('✅ DOMContentLoaded: App初期化開始');
                this.setupEventListeners();
                this.initializeAuth();
                TabNavigation.init();
            });

            // 既にDOMが読み込み済みの場合
            if (document.readyState === 'loading') {
                console.log('⏳ DOM読み込み待機中...');
            } else {
                console.log('🔄 DOMは既に読み込み済み、即座に初期化実行');
                this.setupEventListeners();
                this.initializeAuth();
                TabNavigation.init();
            }
        },

        // 認証システムの初期化
        initializeAuth: function () {
            console.log('🔐 認証システム初期化開始');
            console.log('🔍 Auth オブジェクト確認:', !!window.Auth);

            if (!window.Auth) {
                console.error('❌ Authコンポーネントが読み込まれていません！');
                alert('システムエラー: 認証コンポーネントが読み込まれていません。');
                return;
            }

            // 認証状態変更時のコールバック設定
            Auth.onAuthStateChanged = (authState) => {
                console.log('📢 認証状態変更通知:', authState);
                if (authState.isAuthenticated && authState.studentData) {
                    console.log('✅ 認証成功 - アプリ開始');
                    // 認証成功時：学生データを設定してアプリを開始
                    this.setState('studentData', authState.studentData);
                    this.setState('currentUserEmail', authState.currentUser.email);
                    this.loadInitialData();
                } else {
                    console.log('❌ 認証失敗またはデータ不足');
                }
            };

            // 認証開始
            console.log('🚀 Auth.init() 呼び出し');
            Auth.init();
        },

        // イベントリスナーの設定
        setupEventListeners: function () {
            // ページ離脱時の警告（未保存の変更がある場合）
            window.addEventListener('beforeunload', (e) => {
                if (this.hasUnsavedChanges()) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // キーボードショートカット
            document.addEventListener('keydown', (e) => {
                // Ctrl+R で手動リフレッシュ
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    this.refresh();
                }
            });
        },

        // 初期データの読み込み
        loadInitialData: function () {
            this.state.isLoading.student = true;
            this.state.isLoading.subjects = true;
            this.state.isLoading.registrations = true;

            // 並列でデータを読み込み
            Promise.all([
                this.loadStudentData(),
                this.loadSubjectData(),
                this.loadRegistrationData()
            ]).then(() => {
                console.log('全データの読み込み完了');
                this.onDataLoadComplete();
            }).catch((error) => {
                console.error('データ読み込みエラー:', error);
                this.handleGlobalError(error);
            });
        },

        // 学生データの読み込み（認証後）
        loadStudentData: function () {
            return new Promise((resolve, reject) => {
                // 認証済みの学生データが既にあるかチェック
                if (this.state.studentData && this.state.studentData.id) {
                    console.log('学生データを表示中:', this.state.studentData);
                    StudentInfo.display(this.state.studentData);
                    this.state.isLoading.student = false;
                    resolve(this.state.studentData);
                } else {
                    // 認証されていない場合はエラー
                    console.error('学生情報が認証されていません');
                    this.state.isLoading.student = false;
                    reject(new Error('学生情報が認証されていません'));
                }
            });
        },

        // 科目データの読み込み
        loadSubjectData: function () {
            return new Promise((resolve, reject) => {
                // 学生データが読み込まれているかチェック
                if (!this.state.studentData || !this.state.studentData.id) {
                    console.error('学生データが読み込まれていません');
                    this.state.isLoading.subjects = false;
                    reject(new Error('学生データが読み込まれていません'));
                    return;
                }

                console.log('科目データを読み込み中...', {
                    grade: this.state.studentData.grade,
                    studentId: this.state.studentData.id
                });

                DataLoader.getAvailableSubjects(
                    this.state.studentData.grade || '2',
                    this.state.studentData.id, // 実際の学生IDを使用
                    (subjects) => {
                        console.log('科目データ取得成功:', subjects);
                        const formattedSubjects = subjects.map(subject => ({
                            id: subject.id,
                            name: subject.name,
                            credits: subject.credits,
                            grade: subject.targetGrade,
                            type: subject.type,
                            condition: subject.condition,
                            available: true
                        }));

                        this.setState('subjectData', formattedSubjects);
                        this.state.isLoading.subjects = false;
                        resolve(formattedSubjects);
                    },
                    (error) => {
                        console.error('科目データ読み込みエラー:', error);
                        this.state.isLoading.subjects = false;
                        reject(error);
                    }
                );
            });
        },

        // 履修登録データの読み込み
        loadRegistrationData: function () {
            return new Promise((resolve, reject) => {
                const studentId = this.state.studentData ? this.state.studentData.id : null;
                if (!studentId) {
                    console.error('学生情報が読み込まれていません');
                    this.state.isLoading.registrations = false;
                    reject(new Error('学生情報が読み込まれていません'));
                    return;
                }

                console.log('履修登録データを読み込み中...', { studentId });

                DataLoader.getStudentRegistrations(
                    studentId,
                    (registrations) => {
                        console.log('履修登録データ取得成功:', registrations);
                        // 新しいデータ構造では、registrations配列に既に科目名とステータスが含まれている
                        const registeredSubjects = registrations.map(reg => ({
                            id: `REG_${reg.subjectName}`, // 科目名から一意IDを生成
                            name: reg.subjectName,
                            status: reg.status,
                            credits: this.getSubjectCredits(reg.subjectName), // 科目名から単位数を推定
                            type: this.getSubjectType(reg.subjectName)         // 科目名から種別を推定
                        }));

                        this.setState('registeredSubjects', registeredSubjects);
                        this.state.isLoading.registrations = false;
                        resolve(registeredSubjects);
                    },
                    (error) => {
                        console.error('履修登録データ読み込みエラー:', error);
                        this.state.isLoading.registrations = false;
                        reject(error);
                    }
                );
            });
        },

        // 科目名から単位数を推定するヘルパー関数
        getSubjectCredits: function (subjectName) {
            // 一般的な単位数の推定（後で詳細設定可能）
            if (subjectName.includes('体育')) return 1;
            if (subjectName.includes('保健')) return 1;
            if (subjectName.includes('美術')) return 2;
            if (subjectName.includes('総合')) return 1;
            return 2; // デフォルト
        },

        // 科目名から種別を推定するヘルパー関数
        getSubjectType: function (subjectName) {
            const requiredSubjects = ['現代の国語', '歴史総合', '地理総合', '数学Ⅰ', '科学と人間生活', '体育Ⅰ', '英語コミュニケーションⅠ', '情報Ⅰ'];
            if (requiredSubjects.some(req => subjectName.includes(req.replace(/ｺﾐｭﾆｹｰｼｮﾝ/g, 'コミュニケーション')))) {
                return '必修';
            }
            return '選択';
        },

        // 全データ読み込み完了時の処理
        onDataLoadComplete: function () {
            // ローディング状態を非表示
            DataLoader.hideLoading(Constants.ELEMENTS.LOADING_AVAILABLE);
            DataLoader.hideLoading(Constants.ELEMENTS.LOADING_REGISTERED);

            // 各コンポーネントの表示を更新
            SubjectList.displayAvailable();
            SubjectList.displayRegistered();
            Summary.update();

            // UI要素を表示
            document.getElementById(Constants.ELEMENTS.AVAILABLE_SUBJECTS).style.display = 'grid';
            document.getElementById(Constants.ELEMENTS.REGISTERED_SUBJECTS).style.display = 'grid';
        },

        // 状態の更新（ReactのsetStateのような機能）
        setState: function (key, value) {
            const oldValue = this.state[key];
            this.state[key] = value;

            // 状態変更の通知（デバッグ用）
            console.log(`State changed: ${key}`, { old: oldValue, new: value });

            // 状態変更に応じた処理
            this.onStateChange(key, value, oldValue);
        },

        // 状態変更時の処理
        onStateChange: function (key, newValue, oldValue) {
            switch (key) {
                case 'registeredSubjects':
                    // グローバル変数も更新（互換性維持）
                    registeredSubjects = newValue;
                    break;
                case 'subjectData':
                    subjectData = newValue;
                    break;
                case 'studentData':
                    studentData = newValue;
                    break;
            }
        },

        // データの手動リフレッシュ
        refresh: function () {
            console.log('データをリフレッシュ中...');
            if (Auth.isReady()) {
                this.loadInitialData();
            } else {
                Auth.retry();
            }
        },

        // グローバルエラーハンドラー
        handleGlobalError: function (error) {
            console.error('アプリケーションエラー:', error);

            // ローディング状態をリセット
            this.state.isLoading.student = false;
            this.state.isLoading.subjects = false;
            this.state.isLoading.registrations = false;

            // ユーザーに分かりやすいエラーメッセージを表示
            const errorMessage = this.getErrorMessage(error);

            // エラー表示エリアに表示
            const errorContainer = document.getElementById('auth-error-container');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="auth-error">
                        <h3>⚠️ エラーが発生しました</h3>
                        <p>${errorMessage}</p>
                        <div class="auth-error-actions">
                            <button onclick="App.refresh()" class="retry-button">再試行</button>
                            <button onclick="location.reload()" class="help-button">ページを再読み込み</button>
                        </div>
                    </div>
                `;
                errorContainer.style.display = 'block';
            } else {
                alert(`エラーが発生しました: ${errorMessage}`);
            }
        },

        // エラーメッセージの取得
        getErrorMessage: function (error) {
            if (error.message) {
                return error.message;
            }
            return Constants.UI.ERROR_MESSAGES.GENERAL_ERROR;
        },


        // 未保存の変更があるかチェック
        hasUnsavedChanges: function () {
            // 現在は常にfalse（将来の機能拡張用）
            return false;
        },

        // アプリケーション状態の取得（デバッグ用）
        getState: function () {
            return { ...this.state };
        },

        // パフォーマンス計測
        startPerformanceMeasure: function (name) {
            performance.mark(`${name}-start`);
        },

        endPerformanceMeasure: function (name) {
            performance.mark(`${name}-end`);
            performance.measure(name, `${name}-start`, `${name}-end`);
            const measure = performance.getEntriesByName(name)[0];
            console.log(`Performance: ${name} took ${measure.duration.toFixed(2)}ms`);
        }
    };

    // アプリケーション開始
    App.init();

    // グローバルに公開（デバッグ用）
    window.App = App;
</script>