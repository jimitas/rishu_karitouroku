<script>
    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†
    const App = {
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†
        state: {
            studentData: {},
            subjectData: [],
            registeredSubjects: [],
            isLoading: {
                student: false,
                subjects: false,
                registrations: false
            },
            currentTab: 'available'
        },

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        init: function () {
            console.log('ğŸš€ å±¥ä¿®ç™»éŒ²ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹...');
            console.log('ğŸ“‹ ç¾åœ¨ã®èª­ã¿è¾¼ã¿çŠ¶æ…‹:', document.readyState);

            // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã®å‡¦ç†
            document.addEventListener('DOMContentLoaded', () => {
                console.log('âœ… DOMContentLoaded: AppåˆæœŸåŒ–é–‹å§‹');
                this.setupEventListeners();
                this.initializeAuth();
                TabNavigation.init();
            });

            // æ—¢ã«DOMãŒèª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆ
            if (document.readyState === 'loading') {
                console.log('â³ DOMèª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...');
            } else {
                console.log('ğŸ”„ DOMã¯æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã€å³åº§ã«åˆæœŸåŒ–å®Ÿè¡Œ');
                this.setupEventListeners();
                this.initializeAuth();
                TabNavigation.init();
            }
        },

        // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
        initializeAuth: function () {
            console.log('ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
            console.log('ğŸ” Auth ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç¢ºèª:', !!window.Auth);

            if (!window.Auth) {
                console.error('âŒ Authã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼');
                alert('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: èªè¨¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            // èªè¨¼çŠ¶æ…‹å¤‰æ›´æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
            Auth.onAuthStateChanged = (authState) => {
                console.log('ğŸ“¢ èªè¨¼çŠ¶æ…‹å¤‰æ›´é€šçŸ¥:', authState);
                if (authState.isAuthenticated && authState.studentData) {
                    console.log('âœ… èªè¨¼æˆåŠŸ - ã‚¢ãƒ—ãƒªé–‹å§‹');
                    // èªè¨¼æˆåŠŸæ™‚ï¼šå­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦ã‚¢ãƒ—ãƒªã‚’é–‹å§‹
                    this.setState('studentData', authState.studentData);
                    this.setState('currentUserEmail', authState.currentUser.email);
                    this.loadInitialData();
                } else {
                    console.log('âŒ èªè¨¼å¤±æ•—ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ä¸è¶³');
                }
            };

            // èªè¨¼é–‹å§‹
            console.log('ğŸš€ Auth.init() å‘¼ã³å‡ºã—');
            Auth.init();
        },

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        setupEventListeners: function () {
            // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®è­¦å‘Šï¼ˆæœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰
            window.addEventListener('beforeunload', (e) => {
                if (this.hasUnsavedChanges()) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
            document.addEventListener('keydown', (e) => {
                // Ctrl+R ã§æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    this.refresh();
                }
            });
        },

        // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        loadInitialData: function () {
            this.state.isLoading.student = true;
            this.state.isLoading.subjects = true;
            this.state.isLoading.registrations = true;

            // ä¸¦åˆ—ã§ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            Promise.all([
                this.loadStudentData(),
                this.loadSubjectData(),
                this.loadRegistrationData()
            ]).then(() => {
                console.log('å…¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å®Œäº†');
                this.onDataLoadComplete();
            }).catch((error) => {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                this.handleGlobalError(error);
            });
        },

        // å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆèªè¨¼å¾Œï¼‰
        loadStudentData: function () {
            return new Promise((resolve, reject) => {
                // èªè¨¼æ¸ˆã¿ã®å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (this.state.studentData && this.state.studentData.id) {
                    console.log('å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­:', this.state.studentData);
                    StudentInfo.display(this.state.studentData);
                    this.state.isLoading.student = false;
                    resolve(this.state.studentData);
                } else {
                    // èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                    console.error('å­¦ç”Ÿæƒ…å ±ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    this.state.isLoading.student = false;
                    reject(new Error('å­¦ç”Ÿæƒ…å ±ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“'));
                }
            });
        },

        // ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        loadSubjectData: function () {
            return new Promise((resolve, reject) => {
                // å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (!this.state.studentData || !this.state.studentData.id) {
                    console.error('å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    this.state.isLoading.subjects = false;
                    reject(new Error('å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'));
                    return;
                }

                console.log('ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', {
                    grade: this.state.studentData.grade,
                    studentId: this.state.studentData.id
                });

                DataLoader.getAvailableSubjects(
                    this.state.studentData.grade || '2',
                    this.state.studentData.id, // å®Ÿéš›ã®å­¦ç”ŸIDã‚’ä½¿ç”¨
                    (subjects) => {
                        console.log('ç§‘ç›®ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', subjects);
                        const formattedSubjects = subjects.map(subject => ({
                            id: subject.id,
                            name: subject.name,
                            credits: subject.credits,
                            grade: subject.targetGrade,
                            type: subject.type,
                            condition: subject.condition,
                            available: true
                        }));

                        this.setState('subjectData', formattedSubjects);
                        this.state.isLoading.subjects = false;
                        resolve(formattedSubjects);
                    },
                    (error) => {
                        console.error('ç§‘ç›®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                        this.state.isLoading.subjects = false;
                        reject(error);
                    }
                );
            });
        },

        // å±¥ä¿®ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        loadRegistrationData: function () {
            return new Promise((resolve, reject) => {
                const studentId = this.state.studentData ? this.state.studentData.id : null;
                if (!studentId) {
                    console.error('å­¦ç”Ÿæƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    this.state.isLoading.registrations = false;
                    reject(new Error('å­¦ç”Ÿæƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'));
                    return;
                }

                console.log('å±¥ä¿®ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', { studentId });

                DataLoader.getStudentRegistrations(
                    studentId,
                    (registrations) => {
                        console.log('å±¥ä¿®ç™»éŒ²ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', registrations);
                        // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã¯ã€registrationsé…åˆ—ã«æ—¢ã«ç§‘ç›®åã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹
                        const registeredSubjects = registrations.map(reg => ({
                            id: `REG_${reg.subjectName}`, // ç§‘ç›®åã‹ã‚‰ä¸€æ„IDã‚’ç”Ÿæˆ
                            name: reg.subjectName,
                            status: reg.status,
                            credits: this.getSubjectCredits(reg.subjectName), // ç§‘ç›®åã‹ã‚‰å˜ä½æ•°ã‚’æ¨å®š
                            type: this.getSubjectType(reg.subjectName)         // ç§‘ç›®åã‹ã‚‰ç¨®åˆ¥ã‚’æ¨å®š
                        }));

                        this.setState('registeredSubjects', registeredSubjects);
                        this.state.isLoading.registrations = false;
                        resolve(registeredSubjects);
                    },
                    (error) => {
                        console.error('å±¥ä¿®ç™»éŒ²ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                        this.state.isLoading.registrations = false;
                        reject(error);
                    }
                );
            });
        },

        // ç§‘ç›®åã‹ã‚‰å˜ä½æ•°ã‚’æ¨å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        getSubjectCredits: function (subjectName) {
            // ä¸€èˆ¬çš„ãªå˜ä½æ•°ã®æ¨å®šï¼ˆå¾Œã§è©³ç´°è¨­å®šå¯èƒ½ï¼‰
            if (subjectName.includes('ä½“è‚²')) return 1;
            if (subjectName.includes('ä¿å¥')) return 1;
            if (subjectName.includes('ç¾è¡“')) return 2;
            if (subjectName.includes('ç·åˆ')) return 1;
            return 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        },

        // ç§‘ç›®åã‹ã‚‰ç¨®åˆ¥ã‚’æ¨å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        getSubjectType: function (subjectName) {
            const requiredSubjects = ['ç¾ä»£ã®å›½èª', 'æ­´å²ç·åˆ', 'åœ°ç†ç·åˆ', 'æ•°å­¦â… ', 'ç§‘å­¦ã¨äººé–“ç”Ÿæ´»', 'ä½“è‚²â… ', 'è‹±èªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³â… ', 'æƒ…å ±â… '];
            if (requiredSubjects.some(req => subjectName.includes(req.replace(/ï½ºï¾ï½­ï¾†ï½¹ï½°ï½¼ï½®ï¾/g, 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³')))) {
                return 'å¿…ä¿®';
            }
            return 'é¸æŠ';
        },

        // å…¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        onDataLoadComplete: function () {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’éè¡¨ç¤º
            DataLoader.hideLoading(Constants.ELEMENTS.LOADING_AVAILABLE);
            DataLoader.hideLoading(Constants.ELEMENTS.LOADING_REGISTERED);

            // å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
            SubjectList.displayAvailable();
            SubjectList.displayRegistered();
            Summary.update();

            // UIè¦ç´ ã‚’è¡¨ç¤º
            document.getElementById(Constants.ELEMENTS.AVAILABLE_SUBJECTS).style.display = 'grid';
            document.getElementById(Constants.ELEMENTS.REGISTERED_SUBJECTS).style.display = 'grid';
        },

        // çŠ¶æ…‹ã®æ›´æ–°ï¼ˆReactã®setStateã®ã‚ˆã†ãªæ©Ÿèƒ½ï¼‰
        setState: function (key, value) {
            const oldValue = this.state[key];
            this.state[key] = value;

            // çŠ¶æ…‹å¤‰æ›´ã®é€šçŸ¥ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            console.log(`State changed: ${key}`, { old: oldValue, new: value });

            // çŠ¶æ…‹å¤‰æ›´ã«å¿œã˜ãŸå‡¦ç†
            this.onStateChange(key, value, oldValue);
        },

        // çŠ¶æ…‹å¤‰æ›´æ™‚ã®å‡¦ç†
        onStateChange: function (key, newValue, oldValue) {
            switch (key) {
                case 'registeredSubjects':
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚‚æ›´æ–°ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
                    registeredSubjects = newValue;
                    break;
                case 'subjectData':
                    subjectData = newValue;
                    break;
                case 'studentData':
                    studentData = newValue;
                    break;
            }
        },

        // ãƒ‡ãƒ¼ã‚¿ã®æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        refresh: function () {
            console.log('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ä¸­...');
            if (Auth.isReady()) {
                this.loadInitialData();
            } else {
                Auth.retry();
            }
        },

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        handleGlobalError: function (error) {
            console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', error);

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            this.state.isLoading.student = false;
            this.state.isLoading.subjects = false;
            this.state.isLoading.registrations = false;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const errorMessage = this.getErrorMessage(error);

            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            const errorContainer = document.getElementById('auth-error-container');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="auth-error">
                        <h3>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
                        <p>${errorMessage}</p>
                        <div class="auth-error-actions">
                            <button onclick="App.refresh()" class="retry-button">å†è©¦è¡Œ</button>
                            <button onclick="location.reload()" class="help-button">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</button>
                        </div>
                    </div>
                `;
                errorContainer.style.display = 'block';
            } else {
                alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${errorMessage}`);
            }
        },

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—
        getErrorMessage: function (error) {
            if (error.message) {
                return error.message;
            }
            return Constants.UI.ERROR_MESSAGES.GENERAL_ERROR;
        },


        // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        hasUnsavedChanges: function () {
            // ç¾åœ¨ã¯å¸¸ã«falseï¼ˆå°†æ¥ã®æ©Ÿèƒ½æ‹¡å¼µç”¨ï¼‰
            return false;
        },

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        getState: function () {
            return { ...this.state };
        },

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬
        startPerformanceMeasure: function (name) {
            performance.mark(`${name}-start`);
        },

        endPerformanceMeasure: function (name) {
            performance.mark(`${name}-end`);
            performance.measure(name, `${name}-start`, `${name}-end`);
            const measure = performance.getEntriesByName(name)[0];
            console.log(`Performance: ${name} took ${measure.duration.toFixed(2)}ms`);
        }
    };

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    App.init();

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    window.App = App;
</script>