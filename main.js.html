<script>
    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†
    const App = {
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†
        state: {
            studentData: {},
            subjectData: [],
            registeredSubjects: [],
            isLoading: {
                student: false,
                subjects: false,
                registrations: false
            },
            currentTab: 'available'
        },

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        init: function() {
            console.log('å±¥ä¿®ç™»éŒ²ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹...');

            // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã®å‡¦ç†
            document.addEventListener('DOMContentLoaded', () => {
                this.setupEventListeners();
                this.loadInitialData();
                TabNavigation.init();
            });
        },

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        setupEventListeners: function() {
            // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®è­¦å‘Šï¼ˆæœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰
            window.addEventListener('beforeunload', (e) => {
                if (this.hasUnsavedChanges()) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
            document.addEventListener('keydown', (e) => {
                // Ctrl+R ã§æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    this.refresh();
                }
            });
        },

        // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        loadInitialData: function() {
            this.state.isLoading.student = true;
            this.state.isLoading.subjects = true;
            this.state.isLoading.registrations = true;

            // ä¸¦åˆ—ã§ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            Promise.all([
                this.loadStudentData(),
                this.loadSubjectData(),
                this.loadRegistrationData()
            ]).then(() => {
                console.log('å…¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å®Œäº†');
                this.onDataLoadComplete();
            }).catch((error) => {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                this.handleGlobalError(error);
            });
        },

        // å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒ™ãƒ¼ã‚¹ï¼‰
        loadStudentData: function() {
            return new Promise((resolve, reject) => {
                // ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
                DataLoader.getCurrentUserEmail(
                    (userResult) => {
                        if (userResult.success) {
                            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰å­¦ç”Ÿæƒ…å ±ã‚’å–å¾—
                            DataLoader.getStudentInfoByEmail(
                                userResult.email,
                                (studentResult) => {
                                    if (studentResult.success) {
                                        this.setState('studentData', studentResult.student);
                                        this.setState('currentUserEmail', userResult.email);
                                        StudentInfo.display(studentResult.student);
                                        this.state.isLoading.student = false;
                                        resolve(studentResult.student);
                                    } else {
                                        this.state.isLoading.student = false;
                                        this.showAuthenticationError(studentResult.message);
                                        reject(new Error(studentResult.message));
                                    }
                                },
                                (error) => {
                                    this.state.isLoading.student = false;
                                    this.showAuthenticationError('å­¦ç”Ÿæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                                    reject(error);
                                }
                            );
                        } else {
                            this.state.isLoading.student = false;
                            this.showAuthenticationError(userResult.message);
                            reject(new Error(userResult.message));
                        }
                    },
                    (error) => {
                        this.state.isLoading.student = false;
                        this.showAuthenticationError('ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                        reject(error);
                    }
                );
            });
        },

        // ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        loadSubjectData: function() {
            return new Promise((resolve, reject) => {
                DataLoader.getAvailableSubjects(
                    this.state.studentData.grade || '2',
                    Constants.STUDENT.DEFAULT_ID,
                    (subjects) => {
                        const formattedSubjects = subjects.map(subject => ({
                            id: subject.id,
                            name: subject.name,
                            credits: subject.credits,
                            grade: subject.targetGrade,
                            type: subject.type,
                            condition: subject.condition,
                            available: true
                        }));

                        this.setState('subjectData', formattedSubjects);
                        this.state.isLoading.subjects = false;
                        resolve(formattedSubjects);
                    },
                    (error) => {
                        this.state.isLoading.subjects = false;
                        reject(error);
                    }
                );
            });
        },

        // å±¥ä¿®ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        loadRegistrationData: function() {
            return new Promise((resolve, reject) => {
                const studentId = this.state.studentData.id;
                if (!studentId) {
                    reject(new Error('å­¦ç”Ÿæƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'));
                    return;
                }

                DataLoader.getStudentRegistrations(
                    studentId,
                    (registrations) => {
                        // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã¯ã€registrationsé…åˆ—ã«æ—¢ã«ç§‘ç›®åã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹
                        const registeredSubjects = registrations.map(reg => ({
                            id: `REG_${reg.subjectName}`, // ç§‘ç›®åã‹ã‚‰ä¸€æ„IDã‚’ç”Ÿæˆ
                            name: reg.subjectName,
                            status: reg.status,
                            credits: this.getSubjectCredits(reg.subjectName), // ç§‘ç›®åã‹ã‚‰å˜ä½æ•°ã‚’æ¨å®š
                            type: this.getSubjectType(reg.subjectName)         // ç§‘ç›®åã‹ã‚‰ç¨®åˆ¥ã‚’æ¨å®š
                        }));

                        this.setState('registeredSubjects', registeredSubjects);
                        this.state.isLoading.registrations = false;
                        resolve(registeredSubjects);
                    },
                    (error) => {
                        this.state.isLoading.registrations = false;
                        reject(error);
                    }
                );
            });
        },

        // ç§‘ç›®åã‹ã‚‰å˜ä½æ•°ã‚’æ¨å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        getSubjectCredits: function(subjectName) {
            // ä¸€èˆ¬çš„ãªå˜ä½æ•°ã®æ¨å®šï¼ˆå¾Œã§è©³ç´°è¨­å®šå¯èƒ½ï¼‰
            if (subjectName.includes('ä½“è‚²')) return 1;
            if (subjectName.includes('ä¿å¥')) return 1;
            if (subjectName.includes('ç¾è¡“')) return 2;
            if (subjectName.includes('ç·åˆ')) return 1;
            return 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        },

        // ç§‘ç›®åã‹ã‚‰ç¨®åˆ¥ã‚’æ¨å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        getSubjectType: function(subjectName) {
            const requiredSubjects = ['ç¾ä»£ã®å›½èª', 'æ­´å²ç·åˆ', 'åœ°ç†ç·åˆ', 'æ•°å­¦â… ', 'ç§‘å­¦ã¨äººé–“ç”Ÿæ´»', 'ä½“è‚²â… ', 'è‹±èªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³â… ', 'æƒ…å ±â… '];
            if (requiredSubjects.some(req => subjectName.includes(req.replace(/ï½ºï¾ï½­ï¾†ï½¹ï½°ï½¼ï½®ï¾/g, 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³')))) {
                return 'å¿…ä¿®';
            }
            return 'é¸æŠ';
        },

        // å…¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        onDataLoadComplete: function() {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’éè¡¨ç¤º
            DataLoader.hideLoading(Constants.ELEMENTS.LOADING_AVAILABLE);
            DataLoader.hideLoading(Constants.ELEMENTS.LOADING_REGISTERED);

            // å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
            SubjectList.displayAvailable();
            SubjectList.displayRegistered();
            Summary.update();

            // UIè¦ç´ ã‚’è¡¨ç¤º
            document.getElementById(Constants.ELEMENTS.AVAILABLE_SUBJECTS).style.display = 'grid';
            document.getElementById(Constants.ELEMENTS.REGISTERED_SUBJECTS).style.display = 'grid';
        },

        // çŠ¶æ…‹ã®æ›´æ–°ï¼ˆReactã®setStateã®ã‚ˆã†ãªæ©Ÿèƒ½ï¼‰
        setState: function(key, value) {
            const oldValue = this.state[key];
            this.state[key] = value;

            // çŠ¶æ…‹å¤‰æ›´ã®é€šçŸ¥ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            console.log(`State changed: ${key}`, { old: oldValue, new: value });

            // çŠ¶æ…‹å¤‰æ›´ã«å¿œã˜ãŸå‡¦ç†
            this.onStateChange(key, value, oldValue);
        },

        // çŠ¶æ…‹å¤‰æ›´æ™‚ã®å‡¦ç†
        onStateChange: function(key, newValue, oldValue) {
            switch (key) {
                case 'registeredSubjects':
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚‚æ›´æ–°ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
                    registeredSubjects = newValue;
                    break;
                case 'subjectData':
                    subjectData = newValue;
                    break;
                case 'studentData':
                    studentData = newValue;
                    break;
            }
        },

        // ãƒ‡ãƒ¼ã‚¿ã®æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        refresh: function() {
            console.log('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ä¸­...');
            this.loadInitialData();
        },

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        handleGlobalError: function(error) {
            console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', error);

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const errorMessage = this.getErrorMessage(error);
            alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${errorMessage}`);
        },

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—
        getErrorMessage: function(error) {
            if (error.message) {
                return error.message;
            }
            return Constants.UI.ERROR_MESSAGES.GENERAL_ERROR;
        },

        // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®è¡¨ç¤º
        showAuthenticationError: function(message) {
            console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', message);

            // UIä¸Šã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const errorContainer = document.getElementById('auth-error-container');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="auth-error">
                        <h3>ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™</h3>
                        <p>${message}</p>
                        <p>ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ç™»éŒ²æ¸ˆã¿å­¦ç”Ÿã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
                        <button onclick="App.refresh()" class="retry-button">å†è©¦è¡Œ</button>
                    </div>
                `;
                errorContainer.style.display = 'block';
            }

            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            const contentArea = document.getElementById('main-content');
            if (contentArea) {
                contentArea.style.display = 'none';
            }
        },

        // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        hasUnsavedChanges: function() {
            // ç¾åœ¨ã¯å¸¸ã«falseï¼ˆå°†æ¥ã®æ©Ÿèƒ½æ‹¡å¼µç”¨ï¼‰
            return false;
        },

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        getState: function() {
            return { ...this.state };
        },

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬
        startPerformanceMeasure: function(name) {
            performance.mark(`${name}-start`);
        },

        endPerformanceMeasure: function(name) {
            performance.mark(`${name}-end`);
            performance.measure(name, `${name}-start`, `${name}-end`);
            const measure = performance.getEntriesByName(name)[0];
            console.log(`Performance: ${name} took ${measure.duration.toFixed(2)}ms`);
        }
    };

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    App.init();

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    window.App = App;
</script>