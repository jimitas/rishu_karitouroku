<!-- ユーティリティ関数の読み込み -->
<?!= include('utils/constants'); ?>
<?!= include('utils/dataLoader'); ?>

<!-- JavaScriptコンポーネントの読み込み -->
<?!= include('components/auth'); ?>
<?!= include('components/studentInfo'); ?>
<?!= include('components/subjectList'); ?>
<?!= include('components/registration'); ?>
<?!= include('components/summary'); ?>
<?!= include('components/tabNavigation'); ?>

<!-- メインアプリケーション -->
<?!= include('main'); ?>

<script>
    // グローバル変数（互換性維持のため）
    let studentData = {};
    let subjectData = [];
    let registeredSubjects = [];

    // 旧関数名との互換性維持（段階的移行のため）
    function loadStudentInfo() {
        App.loadStudentData();
    }

    function loadSubjects() {
        App.loadSubjectData();
    }

    function loadRegistrations() {
        App.loadRegistrationData();
    }

    function displayAvailableSubjects() {
        SubjectList.displayAvailable();
    }

    function displayRegisteredSubjects() {
        SubjectList.displayRegistered();
    }

    function updateSummary() {
        Summary.update();
    }

    function registerSubject(subjectId) {
        Registration.register(subjectId);
    }

    function unregisterSubject(subjectId) {
        Registration.unregister(subjectId);
    }

    // 手動リフレッシュ用のグローバル関数
    function refreshData() {
        App.refresh();
    }

    // タブ切り替え用のグローバル関数（HTMLから呼び出し用）
    function showTab(tabName) {
        // DOMContentLoadedを待ってからTabNavigationを呼び出す
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                showTab(tabName);
            });
            return;
        }

        if (window.TabNavigation && TabNavigation.showTab) {
            TabNavigation.showTab(tabName);
        } else {
            console.error('TabNavigationコンポーネントが読み込まれていません');
            console.log('利用可能なオブジェクト:', Object.keys(window).filter(k => k.includes('Tab')));
        }
    }

    // DOM読み込み完了後に実行される初期化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded: すべてのスクリプトが読み込まれました');
        console.log('TabNavigation available:', !!window.TabNavigation);

        // TabNavigationが利用可能かチェック
        if (window.TabNavigation) {
            console.log('TabNavigation methods:', Object.keys(TabNavigation));
        }

        // タブボタンにイベントリスナーを追加
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                console.log('タブクリック:', tabName);
                if (tabName) {
                    showTab(tabName);
                }
            });
        });
    });
</script>