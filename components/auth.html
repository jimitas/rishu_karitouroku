<script>
    // èªè¨¼ç®¡ç†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    const Auth = {
        // èªè¨¼çŠ¶æ…‹
        state: {
            isAuthenticated: false,
            currentUser: null,
            studentData: null,
            isLoading: false
        },

        // èªè¨¼åˆæœŸåŒ–
        init: function () {
            console.log('èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...');
            this.authenticate();
        },

        // èªè¨¼å‡¦ç†
        authenticate: function () {
            this.state.isLoading = true;
            this.showLoadingMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ä¸­...');

            return new Promise((resolve, reject) => {
                console.log('èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹...');

                // ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
                DataLoader.getCurrentUserEmail(
                    (userResult) => {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼çµæœ:', userResult);

                        if (userResult.success) {
                            this.state.currentUser = {
                                email: userResult.email
                            };
                            console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æˆåŠŸ:', userResult.email);

                            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰å­¦ç”Ÿæƒ…å ±ã‚’å–å¾—
                            this.getStudentByEmail(userResult.email)
                                .then((studentData) => {
                                    this.state.isAuthenticated = true;
                                    this.state.studentData = studentData;
                                    this.state.isLoading = false;
                                    console.log('å­¦ç”Ÿèªè¨¼æˆåŠŸ:', studentData);
                                    this.hideLoadingMessage();
                                    this.notifyAuthStateChanged();
                                    resolve(studentData);
                                })
                                .catch((error) => {
                                    console.error('å­¦ç”Ÿæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                                    this.state.isLoading = false;
                                    this.handleAuthenticationError(error.message);
                                    reject(error);
                                });
                        } else {
                            this.state.isLoading = false;
                            const errorMsg = userResult.message || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
                            console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼å¤±æ•—:', errorMsg);
                            this.handleAuthenticationError(errorMsg);
                            reject(new Error(errorMsg));
                        }
                    },
                    (error) => {
                        console.error('GASå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                        this.state.isLoading = false;
                        const errorMsg = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error);
                        this.handleAuthenticationError(errorMsg);
                        reject(error);
                    }
                );
            });
        },

        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰å­¦ç”Ÿæƒ…å ±ã‚’å–å¾—
        getStudentByEmail: function (email) {
            return new Promise((resolve, reject) => {
                DataLoader.getStudentInfoByEmail(
                    email,
                    (studentResult) => {
                        if (studentResult.success) {
                            resolve(studentResult.student);
                        } else {
                            reject(new Error(studentResult.message));
                        }
                    },
                    (error) => {
                        reject(new Error('å­¦ç”Ÿæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
                    }
                );
            });
        },

        // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
        handleAuthenticationError: function (message) {
            console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', message);
            this.showAuthenticationError(message);
        },

        // èªè¨¼ã‚¨ãƒ©ãƒ¼ç”»é¢ã®è¡¨ç¤º
        showAuthenticationError: function (message) {
            const errorContainer = document.getElementById('auth-error-container');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="auth-error">
                        <h3>ğŸ”’ ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™</h3>
                        <p>${message}</p>
                        <p>ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ç™»éŒ²æ¸ˆã¿å­¦ç”Ÿã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
                        <div class="auth-error-actions">
                            <button onclick="Auth.retry()" class="retry-button">å†è©¦è¡Œ</button>
                            <button onclick="Auth.showHelp()" class="help-button">ãƒ˜ãƒ«ãƒ—</button>
                        </div>
                    </div>
                `;
                errorContainer.style.display = 'block';
            }

            // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            this.hideMainContent();
        },

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        showLoadingMessage: function (message) {
            const errorContainer = document.getElementById('auth-error-container');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="auth-loading">
                        <div class="loading-spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
                errorContainer.style.display = 'block';
            }

            this.hideMainContent();
        },

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        hideLoadingMessage: function () {
            const errorContainer = document.getElementById('auth-error-container');
            if (errorContainer) {
                errorContainer.style.display = 'none';
            }

            this.showMainContent();
        },

        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
        hideMainContent: function () {
            const contentArea = document.getElementById('main-content');
            if (contentArea) {
                contentArea.style.display = 'none';
            }
        },

        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
        showMainContent: function () {
            const contentArea = document.getElementById('main-content');
            if (contentArea) {
                contentArea.style.display = 'block';
            }
        },

        // èªè¨¼ã®å†è©¦è¡Œ
        retry: function () {
            console.log('èªè¨¼ã‚’å†è©¦è¡Œä¸­...');
            this.state.isAuthenticated = false;
            this.state.currentUser = null;
            this.state.studentData = null;
            this.authenticate();
        },

        // ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
        showHelp: function () {
            alert(`ãƒ˜ãƒ«ãƒ—æƒ…å ±:

1. å­¦æ ¡ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„
2. ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§Cookieã¨JavaScriptãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„
3. å•é¡ŒãŒç¶šãå ´åˆã¯ã€ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„

ãŠå•ã„åˆã‚ã›å…ˆ: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…`);
        },

        // ç¾åœ¨ã®èªè¨¼çŠ¶æ…‹ã‚’å–å¾—
        getAuthState: function () {
            return {
                isAuthenticated: this.state.isAuthenticated,
                currentUser: this.state.currentUser,
                studentData: this.state.studentData,
                isLoading: this.state.isLoading
            };
        },

        // å­¦ç”ŸIDã‚’å–å¾—ï¼ˆä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”¨ï¼‰
        getCurrentStudentId: function () {
            return this.state.studentData ? this.state.studentData.id : null;
        },

        // å­¦ç”Ÿæƒ…å ±ã‚’å–å¾—ï¼ˆä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”¨ï¼‰
        getCurrentStudentData: function () {
            return this.state.studentData;
        },

        // èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        isReady: function () {
            return this.state.isAuthenticated && !this.state.isLoading;
        },

        // èªè¨¼çŠ¶æ…‹å¤‰æ›´æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆApp.jsã‹ã‚‰è¨­å®šï¼‰
        onAuthStateChanged: null,

        // èªè¨¼çŠ¶æ…‹å¤‰æ›´ã‚’é€šçŸ¥
        notifyAuthStateChanged: function () {
            if (this.onAuthStateChanged && typeof this.onAuthStateChanged === 'function') {
                this.onAuthStateChanged(this.getAuthState());
            }
        }
    };
</script>