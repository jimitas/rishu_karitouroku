<script>
    // 履修登録・取消コンポーネント
    const Registration = {
        // 履修登録情報の読み込み
        loadRegistrations: function() {
            const studentId = 'S2023001'; // 仮の学生ID

            // まず履修登録データを取得
            google.script.run
                .withSuccessHandler(function(registrations) {
                    // 次に科目詳細を取得
                    const subjectIds = registrations.map(reg => reg.subjectId);

                    if (subjectIds.length > 0) {
                        google.script.run
                            .withSuccessHandler(function(subjects) {
                                registeredSubjects = subjects
                                    .filter(subject => subjectIds.includes(subject.id))
                                    .map(subject => ({
                                        id: subject.id,
                                        name: subject.name,
                                        credits: subject.credits,
                                        type: subject.type
                                    }));

                                SubjectList.displayRegistered();
                                Summary.update();
                                document.getElementById('loading-registered').style.display = 'none';
                                document.getElementById('registered-subjects').style.display = 'grid';
                            })
                            .withFailureHandler(function(error) {
                                document.getElementById('loading-registered').innerHTML =
                                    '<div class="error">科目情報の取得エラー: ' + error.message + '</div>';
                            })
                            .getSubjects();
                    } else {
                        registeredSubjects = [];
                        SubjectList.displayRegistered();
                        Summary.update();
                        document.getElementById('loading-registered').style.display = 'none';
                        document.getElementById('registered-subjects').style.display = 'grid';
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading-registered').innerHTML =
                        '<div class="error">履修情報の取得エラー: ' + error.message + '</div>';
                })
                .getStudentRegistrations(studentId);
        },

        // 履修登録
        register: function(subjectId) {
            const studentId = App.state.studentData.id;
            if (!studentId) {
                alert('学生情報が読み込まれていません。');
                return;
            }
            const subject = subjectData.find(s => s.id === subjectId);

            if (subject && confirm(Constants.UI.CONFIRM_MESSAGES.REGISTER(subject.name))) {
                DataLoader.registerSubject(
                    studentId,
                    subject.name, // 科目IDではなく科目名を渡す
                    (result) => {
                        if (result.success) {
                            alert(result.message);
                            this.onRegistrationChange('register', subject);
                        } else {
                            alert(`${Constants.UI.ERROR_MESSAGES.GENERAL_ERROR}: ${result.message}`);
                        }
                    },
                    (error) => {
                        alert(`${Constants.UI.ERROR_MESSAGES.GENERAL_ERROR}: ${error.message}`);
                    }
                );
            }
        },

        // 履修取消
        unregister: function(subjectId) {
            const studentId = App.state.studentData.id;
            if (!studentId) {
                alert('学生情報が読み込まれていません。');
                return;
            }
            const subject = registeredSubjects.find(s => s.id === subjectId);

            if (subject && confirm(Constants.UI.CONFIRM_MESSAGES.UNREGISTER(subject.name))) {
                DataLoader.unregisterSubject(
                    studentId,
                    subject.name, // 科目IDではなく科目名を渡す
                    (result) => {
                        if (result.success) {
                            alert(result.message);
                            this.onRegistrationChange('unregister', subject);
                        } else {
                            alert(`${Constants.UI.ERROR_MESSAGES.GENERAL_ERROR}: ${result.message}`);
                        }
                    },
                    (error) => {
                        alert(`${Constants.UI.ERROR_MESSAGES.GENERAL_ERROR}: ${error.message}`);
                    }
                );
            }
        },

        // 履修状況変更時のコンポーネント間連携
        onRegistrationChange: function(action, subject) {
            console.log(`Registration change: ${action}`, subject);

            // Appの状態管理を使用している場合
            if (window.App) {
                App.refresh();
            } else {
                // フォールバック: 個別にリロード
                this.loadRegistrations();
                SubjectList.load();
            }
        }
    };

    // グローバルスコープに登録
    window.Registration = Registration;
    console.log('✅ Registration コンポーネント登録完了');
</script>