<script>
    // データローダー ユーティリティ
    const DataLoader = {
        /**
         * Google Apps Scriptの呼び出しを簡素化するラッパー関数
         */
        callGAS: function(functionName, params = [], successCallback, errorCallback) {
            const runner = google.script.run
                .withSuccessHandler(successCallback)
                .withFailureHandler(errorCallback);

            return runner[functionName](...params);
        },

        /**
         * 学生情報を取得
         */
        getStudentInfo: function(studentId, successCallback, errorCallback) {
            this.callGAS(
                'getStudentInfo',
                [studentId],
                successCallback,
                errorCallback || this.defaultErrorHandler
            );
        },

        /**
         * 科目情報を取得
         */
        getSubjects: function(successCallback, errorCallback) {
            this.callGAS(
                'getSubjects',
                [],
                successCallback,
                errorCallback || this.defaultErrorHandler
            );
        },

        /**
         * 履修可能科目を取得
         */
        getAvailableSubjects: function(studentGrade, studentId, successCallback, errorCallback) {
            this.callGAS(
                'getAvailableSubjects',
                [studentGrade, studentId],
                successCallback,
                errorCallback || this.defaultErrorHandler
            );
        },

        /**
         * 学生の履修登録情報を取得
         */
        getStudentRegistrations: function(studentId, successCallback, errorCallback) {
            this.callGAS(
                'getStudentRegistrations',
                [studentId],
                successCallback,
                errorCallback || this.defaultErrorHandler
            );
        },

        /**
         * 履修登録を実行
         */
        registerSubject: function(studentId, subjectId, successCallback, errorCallback) {
            this.callGAS(
                'registerSubject',
                [studentId, subjectId],
                successCallback,
                errorCallback || this.defaultErrorHandler
            );
        },

        /**
         * 履修取消を実行
         */
        unregisterSubject: function(studentId, subjectId, successCallback, errorCallback) {
            this.callGAS(
                'unregisterSubject',
                [studentId, subjectId],
                successCallback,
                errorCallback || this.defaultErrorHandler
            );
        },

        /**
         * デフォルトエラーハンドラー
         */
        defaultErrorHandler: function(error) {
            console.error('GAS呼び出しエラー:', error);
            alert('エラーが発生しました: ' + error.message);
        },

        /**
         * ローディング表示の管理
         */
        showLoading: function(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
            }
        },

        hideLoading: function(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        },

        /**
         * エラー表示の管理
         */
        showError: function(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="error">${message}</div>`;
            }
        },

        /**
         * 複数のデータを並列で取得するヘルパー
         */
        loadMultipleData: function(dataRequests) {
            const promises = dataRequests.map(request => {
                return new Promise((resolve, reject) => {
                    this.callGAS(
                        request.functionName,
                        request.params || [],
                        resolve,
                        reject
                    );
                });
            });

            return Promise.all(promises);
        }
    };
</script>